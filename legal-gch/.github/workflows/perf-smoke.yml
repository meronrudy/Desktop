name: CI · Perf Smoke (CPU-only)

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:

concurrency:
  group: perf-smoke-${{ github.ref }}
  cancel-in-progress: true

jobs:
  perf-smoke:
    name: CPU Perf Smoke · ubuntu-latest · py3.10
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install minimal dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Run perf smoke (no gates, CPU-only)
        shell: bash
        env:
          PYTHONPATH: python:${{ env.PYTHONPATH }}
        run: |
          set -euxo pipefail
          # Attempt to run the harness; ignore failure to allow artifact upload
          python bench/perf_overhead.py || true
          # Ensure we always upload a JSON artifact
          if [ ! -f perf_smoke.json ]; then
            python - <<'PY'
import json, time, platform, sys
json.dump({
  "status": "skipped_or_failed",
  "reason": "deps_missing_or_cpu_only",
  "ts": time.time(),
  "python": sys.version,
  "platform": platform.platform()
}, open("perf_smoke.json","w"))
PY
          fi
          ls -l perf_smoke.json

      - name: Upload perf smoke artifact
        uses: actions/upload-artifact@v4
        with:
          name: perf-smoke-cpu
          path: perf_smoke.json
          if-no-files-found: error
          retention-days: 7